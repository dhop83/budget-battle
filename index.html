<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Budget Battle</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    h1, h2 { text-align: center; }
    .hidden { display: none; }
    .slider-group { margin: 1rem 0; }
    label { display: block; margin-bottom: 0.3rem; }
    input[type=range] { width: 100%; }
    button { padding: 0.6rem 1.2rem; font-size: 1rem; margin-top: 1rem; }
    #timerBar { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: .5rem 0; }
    #progress { height: 100%; width: 100%; background: #76c7c0; transform-origin: left; }
    #confetti-canvas { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    #tipOverlay { 
      position: fixed; bottom:20px; left:50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color:#fff; padding:1rem 1.5rem;
      border-radius:8px; font-size:1rem; display:none;
    }
  </style>
</head>
<body>

  <!-- AUDIO -->
  <audio id="lockSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="winSound"  src="https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg"></audio>

  <!-- CONFETTI CANVAS -->
  <canvas id="confetti-canvas"></canvas>

  <!-- TIP OVERLAY -->
  <div id="tipOverlay">üí° Tip: Automate your savings transfer to pay yourself first!</div>

  <!-- 1. SET INCOME -->
  <div id="screen-income">
    <h1>üèÜ Budget Battle</h1>
    <p>Enter your monthly income:</p>
    <input type="number" id="incomeInput" placeholder="e.g. 3500" />
    <button id="incomeNext">Next</button>
  </div>

  <!-- 2. SCENARIO STEPS -->
  <div id="screen-step" class="hidden">
    <h2 id="stepTitle"></h2>
    <p id="stepDesc"></p>

    <div id="budgetForm">
      <p><strong>Income:</strong> $<span id="showIncome"></span></p>
      <div class="slider-group">
        <label>Needs (<span id="needsPct">50</span>%): <span id="needsAmt"></span></label>
        <input type="range" id="needs" min="30" max="70" value="50">
      </div>
      <div class="slider-group">
        <label>Wants (<span id="wantsPct">30</span>%): <span id="wantsAmt"></span></label>
        <input type="range" id="wants" min="10" max="60" value="30">
      </div>
      <div class="slider-group">
        <label>Savings (<span id="savePct">20</span>%): <span id="saveAmt"></span></label>
        <input type="range" id="save" min="10" max="60" value="20">
      </div>
      <div id="timerBar"><div id="progress"></div></div>
      <button id="lockBtn">Lock Allocation</button>
    </div>
  </div>

  <!-- 3. SUMMARY -->
  <div id="screen-summary" class="hidden">
    <h2>üéâ Battle Summary</h2>
    <p id="summaryText"></p>
    <p id="finalScore"></p>
    <button id="restart">Play Again</button>
  </div>

  <!-- CONFETTI LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script>
    // ======= Data & State =======
    const steps = [
      { title: "Step 1: Car Trouble",  desc: "Your car needs a $300 repair. Adjust your budget?", delta: { needs: +300, save: -300 }},
      { title: "Step 2: Side Gig Bonus", desc: "You earn $400 freelancing. Adjust your budget?", delta: { save: +400 }},
      { title: "Step 3: Phone Upgrade", desc: "A new phone costs $250. Adjust your budget?", delta: { wants: +250, save: -250 }},
    ];
    let income, currentStep=0, allocations=[], timerInterval;

    // ======= Elements =======
    const screenIncome  = document.getElementById('screen-income');
    const screenStep    = document.getElementById('screen-step');
    const screenSummary = document.getElementById('screen-summary');
    const incomeInput   = document.getElementById('incomeInput');
    const incomeNext    = document.getElementById('incomeNext');
    const stepTitle     = document.getElementById('stepTitle');
    const stepDesc      = document.getElementById('stepDesc');
    const showIncome    = document.getElementById('showIncome');
    const needs         = document.getElementById('needs');
    const wants         = document.getElementById('wants');
    const save          = document.getElementById('save');
    const needsPct      = document.getElementById('needsPct');
    const wantsPct      = document.getElementById('wantsPct');
    const savePct       = document.getElementById('savePct');
    const needsAmt      = document.getElementById('needsAmt');
    const wantsAmt      = document.getElementById('wantsAmt');
    const saveAmt       = document.getElementById('saveAmt');
    const progressBar   = document.getElementById('progress');
    const lockBtn       = document.getElementById('lockBtn');
    const summaryText   = document.getElementById('summaryText');
    const finalScore    = document.getElementById('finalScore');
    const restart       = document.getElementById('restart');
    const lockSound     = document.getElementById('lockSound');
    const winSound      = document.getElementById('winSound');
    const tipOverlay    = document.getElementById('tipOverlay');

    // ======= Helper: Update Sliders =======
    function updateSliders(){
      const n = +needs.value, w=+wants.value;
      const s = 100 - n - w;
      save.value = s;
      needsPct.textContent = n; wantsPct.textContent = w; savePct.textContent = s;
      needsAmt.textContent = `$${Math.round(income*n/100)}`;
      wantsAmt.textContent= `$${Math.round(income*w/100)}`;
      saveAmt.textContent = `$${Math.round(income*s/100)}`;
    }
    [needs,wants,save].forEach(el=>el.addEventListener('input',updateSliders));

    // ======= Timer =======
    function startTimer(sec=30){
      clearInterval(timerInterval);
      let time=sec;
      progressBar.style.transform = 'scaleX(1)';
      timerInterval = setInterval(()=>{
        time--;
        const pct = time/sec;
        progressBar.style.transform = `scaleX(${pct})`;
        if(time<=0){ clearInterval(timerInterval); lockAllocation(); }
      },1000);
    }

    // ======= Show Next Step =======
    function showStep(){
      if(currentStep>=steps.length){
        return showSummary();
      }
      screenIncome.classList.add('hidden');
      screenSummary.classList.add('hidden');
      screenStep.classList.remove('hidden');

      const {title,desc} = steps[currentStep];
      stepTitle.textContent = title;
      stepDesc.textContent  = desc;
      showIncome.textContent = income;
      // reset to last allocations or default 50/30/20
      const last = allocations[currentStep-1] || {n:50,w:30,s:20};
      needs.value=last.n; wants.value=last.w; save.value=last.s;
      updateSliders();
      startTimer(30);
    }

    // ======= Lock In & Record =======
    function lockAllocation(){
      lockSound.play();
      clearInterval(timerInterval);
      // record
      allocations[currentStep] = {
        n:+needs.value,
        w:+wants.value,
        s:+save.value
      };
      // apply delta
      const {delta} = steps[currentStep];
      income = Math.max(0, income 
        + (delta.needs||0)*(-1)  // repair cost reduces income bucket
        + (delta.wants||0)*(-1) 
        + (delta.save||0)        // bonuses add to income
      );
      currentStep++;
      setTimeout(showStep, 800);
    }
    lockBtn.addEventListener('click',lockAllocation);

    // ======= Summary =======
    function showSummary(){
      screenStep.classList.add('hidden');
      screenSummary.classList.remove('hidden');

      // compute final savings bucket vs ideal
      const last = allocations[allocations.length-1];
      const finalSave = Math.round(income * (last.s/100));
      const idealSave = Math.round(income * 0.20);
      const diff = Math.abs(finalSave - idealSave);
      const score = Math.max(0, 100 - Math.round(diff/idealSave*100));

      summaryText.innerHTML = `
        Your final Savings bucket: <strong>$${finalSave}</strong><br>
        Ideal Savings (20%): <strong>$${idealSave}</strong>
      `;
      finalScore.textContent = `Score: ${score}/100`;

      if(score >= 80){
        winSound.play();
        confetti.create(document.getElementById('confetti-canvas'),{resize:true})({ particleCount:200 });
      }
      // show tip
      tipOverlay.style.display = 'block';
    }

    // ======= Start & Restart =======
    incomeNext.addEventListener('click',()=>{
      income = Number(incomeInput.value)||0;
      currentStep=0; allocations=[];
      if(income<=0){ return alert('Enter a valid income'); }
      showStep();
    });
    restart.addEventListener('click',()=>{
      tipOverlay.style.display='none';
      screenSummary.classList.add('hidden');
      screenIncome.classList.remove('hidden');
      incomeInput.value='';
    });
  </script>
</body>
</html>
